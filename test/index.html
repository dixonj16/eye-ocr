<!DOCTYPE HTML>
<html>
  <head>
    <style>
      #filedrop {
        background-color: #C2C2C2;
        display: table-cell;
        height: 150px;
        width: 200px;
        text-align: center;
        vertical-align: middle;
      }
      #filedrop p {
        font-weight: bold;
        color: #2C2C2C;
      }
      #imageCanvas {
        border: 2px solid #2C2C2C;
        position: absolute;
        top: 0;
        left: 220px;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="../lib/ocr.js"></script>
    <script src="../lib/english_network.js"></script>
    <script src="../node_modules/brain/brain-0.5.0.js"></script>
  </head>
  <body>
    <div id="filedrop">
      <p>Drop Image Here</p>
    </div>

    <canvas id="imageCanvas" width="300" height="200"></canvas>

    <div id="output"></div>

    <script>
      $(function() {
        // Setup Neural Network
        var net = new brain.NeuralNetwork();
        net.fromJSON(english_network);

        // File Drop
        $('#filedrop').on('dragenter dragover', function(e) {
          e.stopPropagation();
          e.preventDefault();
        });

        $('*').on('drop', function(e) {
          e.stopPropagation();
          e.preventDefault();
        });

        $('#filedrop').on('drop', function(e) {
          e.stopPropagation();
          e.preventDefault();

          var files = e.originalEvent.dataTransfer.files;
          var file = files[0];
          var size = file.size;

          if (!file.type.match(/image.*/)) {
            alert("File must be an image!");
            return false;
          }

          var reader = new FileReader(),
              image = new Image();

          reader.onload = function(e) {
            image.onload = function() {
              loadImageCanvas(this);
            }
            image.src = e.target.result;
          }

          reader.readAsDataURL(file);
          return false;
        });

        function loadImageCanvas(image) {
          var canvas = $('#imageCanvas')[0];

          var width = image.width;
          var height = image.height;

          var max = Math.max(width, height)
          var scale = Math.min(max, 500) / max;

          width *= scale;
          height *= scale;

          canvas.width = width;
          canvas.height = height;

          // draw image to preview canvas
          var context = canvas.getContext("2d");
          context.drawImage(image, 0, 0, image.width, image.height,
                            0, 0, width, height);

          // Convert to grey scale
          var imageData = context.getImageData(0, 0, width, height);
          var lines = find_lines(imageData, 100, Math.floor(width * 0.01));

          // Chars
          process_lines(imageData, lines, context);

          // Box Lines 
          //box_lines(imageData, lines);
          
          //convert_grey(imageData);
          imageData = context.putImageData(imageData, 0, 0);
        }

        function find_lines(image_data, threshold, allowed){
          var lines = [];
          var in_line = false;
          for (var y = 0; y < image_data.height; y++){
            var pixels = 0;
            for (var x = 0; x < image_data.width; x++){
              var i = x*4+y*4*image_data.width;
              var luma = Math.floor(image_data.data[i] * 299/1000 +
                image_data.data[i+1] * 587/1000 +
                image_data.data[i+2] * 114/1000);
              image_data.data[i] = luma;
              image_data.data[i+1] = luma;
              image_data.data[i+2] = luma;
              image_data.data[i+3] = 255;

              if (luma < threshold) {
                pixels++;
              }
            }

            if ((pixels > allowed && !in_line)
                || (pixels <= allowed && in_line)) {
              lines.push(y);
              in_line = !in_line;
            }
          }
          return lines;
        }

        function process_lines(image_data, lines, context) {
          var threshold = 100;
          var allowed = 0;
          for (var lineIndex = 0; lineIndex < lines.length; lineIndex+=2) {
            var cols = [];
            var in_col = false;
            for (var x = 0; x < image_data.width; x++){
              var pixels = 0;
              for (var y = lines[lineIndex]; y <= lines[lineIndex+1]; y++){
                var i = x*4+y*4*image_data.width;
                var luma = Math.floor(image_data.data[i] * 299/1000 +
                  image_data.data[i+1] * 587/1000 +
                  image_data.data[i+2] * 114/1000);
                image_data.data[i] = luma;
                image_data.data[i+1] = luma;
                image_data.data[i+2] = luma;
                image_data.data[i+3] = 255;
                
                if (luma < threshold) {
                  pixels++;
                }
              }

              if ((pixels > allowed && !in_col)
                  || (pixels <= allowed && in_col)) {
                cols.push(x);
                in_col = !in_col;
              }
            }

            for (var y = 0; y < lines.length; y+=2) {
              for (var x = 0; x < cols.length; x+=2) {
                var charData = context.getImageData(cols[x], lines[y], cols[x+1] - cols[x], lines[y+1] - lines[y]);

                 var tempCanvas = $("<canvas>")
                     .attr("width", 10)
                     .attr("height", 10)[0];
                 var tempContext = tempCanvas.getContext("2d"); 
                 var scale = Math.min(10/charData.width, 10/charData.height);
                 tempContext.scale(scale, scale);
                 tempContext.putImageData(charData, 0, 0);

                 var charNetwork = getCharNetwork(tempContext.getImageData(0, 0, 10, 10));
                 var result = net.run(charNetwork);
                 console.log(result);
              }
            }
          }
        }

        function box_lines(image_data, lines){
          var in_line = false;
          for (var l = 0; l < lines.length; l++) {
            var y = lines[l];
            for (var x = 0; x < image_data.width; x++){
              var i = x*4+y*4*image_data.width;
              image_data.data[i] = 255;
              image_data.data[i+1] = 0;
              image_data.data[i+2] = 0;
              image_data.data[i+3] = 255;

            }
          }
        }

        // FROM: http://ejohn.org/blog/ocr-and-neural-nets-in-javascript/
        function convert_grey(image_data){
          for (var x = 0; x < image_data.width; x++){
            for (var y = 0; y < image_data.height; y++){
              var i = x*4+y*4*image_data.width;
              var luma = Math.floor(image_data.data[i] * 299/1000 +
                image_data.data[i+1] * 587/1000 +
                image_data.data[i+2] * 114/1000);
              image_data.data[i] = luma;
              image_data.data[i+1] = luma;
              image_data.data[i+2] = luma;
              image_data.data[i+3] = 255;
            }
          }
        }

        function getCharNetwork(image_data){
          var network = [];
          for (var y = 0; y < image_data.height; y++){
            for (var x = 0; x < image_data.width; x++){
              var i = x*4+y*4*image_data.width;

              var luma = Math.floor(image_data.data[i] * 299/1000 +
                image_data.data[i+1] * 587/1000 +
                image_data.data[i+2] * 114/1000);

              network.push(1 - luma/255);
            }
          }

          return network;
        }

      });
    </script>
  </body>
</html>
